<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Invi Finder</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg-deep:#0f0f0f;--bg-card:#1a1a1a;--bg-hover:#242424;--bg-input:#181818;
    --border:#2a2a2a;--border-focus:#e63946;
    --txt:#f0f0f0;--txt2:#8a8a8a;
    --accent:#e63946;--accent-g:rgba(230,57,70,.25);
    --gold:#d4af37;--green:#5a9467;
    --tag-bg:rgba(230,57,70,.08);--tag-border:rgba(230,57,70,.25);
    --r:8px;--r-sm:4px;--shadow:0 6px 30px rgba(0,0,0,.6);
  }
  html{font-size:16px;-webkit-font-smoothing:antialiased;background:var(--bg-deep)}
  body{font-family:'IBM Plex Mono',monospace;background:var(--bg-deep);color:var(--txt);min-height:100vh;line-height:1.6}
  
  /* subtle texture overlay */
  body::after{content:'';position:fixed;inset:0;background:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' /%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");pointer-events:none;z-index:1}

  /* â”€ header â”€ */
  header{position:sticky;top:0;z-index:100;background:rgba(13,8,6,.95);backdrop-filter:blur(12px);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;gap:16px}
  .logo{font-family:'Cinzel',serif;font-weight:700;font-size:1.3rem;background:linear-gradient(135deg,var(--gold),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:1px}
  .logo-sub{font-weight:400;font-size:.75rem;color:var(--txt2);display:block;margin-top:-3px;letter-spacing:2px;text-transform:uppercase}
  
  .header-actions{display:flex;gap:12px;align-items:center}
  .cart-btn{position:relative;background:var(--accent);color:#fff;border:none;border-radius:var(--r-sm);font-family:inherit;font-size:.82rem;font-weight:600;padding:8px 16px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px}
  .cart-btn:hover{background:#ff4757;box-shadow:0 0 16px var(--accent-g)}
  .cart-btn .badge{position:absolute;top:-6px;right:-6px;background:var(--gold);color:#000;border-radius:12px;padding:2px 6px;font-size:.7rem;font-weight:700;min-width:18px;text-align:center}
  
  .meta-info{font-size:.7rem;color:var(--txt2);text-align:right;line-height:1.3}
  .meta-info strong{color:var(--gold)}
  
  /* â”€ layout â”€ */
  .container{max-width:1200px;margin:0 auto;padding:32px 20px;position:relative;z-index:2}
  
  /* â”€ mode toggle â”€ */
  .mode-toggle{display:flex;gap:0;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;margin-bottom:20px;width:fit-content}
  .mode-toggle button{background:none;border:none;color:var(--txt2);font-family:inherit;font-size:.82rem;font-weight:500;padding:10px 20px;cursor:pointer;transition:all .2s}
  .mode-toggle button.active{background:var(--accent);color:#fff}
  
  /* â”€ search panel â”€ */
  .search-panel{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r);padding:24px;margin-bottom:24px;box-shadow:var(--shadow)}
  
  /* single search */
  .search-wrap{position:relative}
  .search-wrap input{background:var(--bg-input);border:1px solid var(--border);border-radius:var(--r-sm);color:var(--txt);font-family:inherit;font-size:.92rem;padding:12px 16px 12px 42px;outline:none;transition:border-color .2s,box-shadow .2s;width:100%}
  .search-wrap input:focus{border-color:var(--border-focus);box-shadow:0 0 0 3px var(--accent-g)}
  .search-wrap .search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--txt2);pointer-events:none;font-size:1.1rem}
  .autocomplete{position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);z-index:200;max-height:300px;overflow-y:auto;display:none}
  .autocomplete.open{display:block}
  .autocomplete-item{padding:10px 14px;cursor:pointer;font-size:.88rem;border-bottom:1px solid var(--border);transition:background .15s;display:flex;align-items:center;gap:10px}
  .autocomplete-item:last-child{border-bottom:none}
  .autocomplete-item:hover{background:var(--bg-hover)}
  .autocomplete-item img{width:50px;height:70px;object-fit:cover;border-radius:4px;flex-shrink:0}
  .autocomplete-item .ac-info{flex:1;min-width:0}
  .autocomplete-item .ac-name{color:var(--txt);font-weight:500}
  .autocomplete-item .ac-type{color:var(--txt2);font-size:.76rem;margin-top:2px}
  
  /* bulk import */
  .bulk-area{display:none}
  .bulk-area.active{display:block}
  .bulk-area textarea{background:var(--bg-input);border:1px solid var(--border);border-radius:var(--r-sm);color:var(--txt);font-family:'IBM Plex Mono',monospace;font-size:.85rem;padding:14px;outline:none;transition:border-color .2s;width:100%;min-height:200px;resize:vertical}
  .bulk-area textarea:focus{border-color:var(--border-focus);box-shadow:0 0 0 3px var(--accent-g)}
  .bulk-area textarea::placeholder{color:var(--txt2)}
  .bulk-actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .btn{background:var(--accent);color:#fff;border:none;border-radius:var(--r-sm);font-family:inherit;font-size:.85rem;font-weight:600;padding:10px 20px;cursor:pointer;transition:all .2s}
  .btn:hover{background:#ff4757;box-shadow:0 0 12px var(--accent-g)}
  .btn-secondary{background:var(--bg-input);color:var(--txt);border:1px solid var(--border)}
  .btn-secondary:hover{background:var(--bg-hover);box-shadow:none}
  
  /* â”€ filter chips â”€ */
  .filter-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:16px}
  .filter-label{font-size:.78rem;color:var(--txt2);text-transform:uppercase;letter-spacing:1.5px;font-weight:600}
  .chip{background:var(--bg-input);border:1px solid var(--border);border-radius:14px;padding:6px 14px;font-size:.8rem;color:var(--txt2);cursor:pointer;transition:all .15s;font-weight:500}
  .chip:hover,.chip.active{border-color:var(--accent);background:var(--tag-bg);color:var(--txt)}
  
  /* â”€ results â”€ */
  .results-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px}
  .results-count{font-size:.82rem;color:var(--txt2);font-weight:500}
  .table-wrap{overflow-x:auto;background:var(--bg-card);border:1px solid var(--border);border-radius:var(--r)}
  table{width:100%;border-collapse:collapse;font-size:.86rem}
  thead th{text-align:left;font-weight:600;font-size:.7rem;text-transform:uppercase;letter-spacing:1.3px;color:var(--txt2);padding:12px 14px;border-bottom:2px solid var(--border);background:var(--bg-input);white-space:nowrap}
  thead th[data-sort]{cursor:pointer;user-select:none;transition:color .15s}
  thead th[data-sort]:hover{color:var(--accent)}
  thead th .sort-arrow{margin-left:4px;opacity:.6;font-size:.65rem}
  tbody tr{border-bottom:1px solid rgba(58,40,32,.4);transition:background .15s;cursor:pointer}
  tbody tr:hover{background:var(--bg-hover)}
  tbody td{padding:12px 14px}
  .card-name-cell{font-weight:600;color:var(--txt)}
  .owner-badges{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .owner-badge{position:relative;display:inline-flex;align-items:center;gap:8px;background:var(--tag-bg);border:1px solid var(--tag-border);border-radius:12px;padding:4px 10px;font-size:.76rem;color:var(--gold);font-weight:600}
  .owner-badge .qty{color:var(--accent);margin-left:2px}
  .owner-badge .add-btn{background:var(--accent);color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:1.2rem;line-height:1;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;padding:0;flex-shrink:0}
  .owner-badge .add-btn:hover{background:#ff4757;transform:scale(1.1)}
  
  /* â”€ empty state â”€ */
  .empty-state{text-align:center;padding:60px 20px;color:var(--txt2)}
  .empty-state .icon{font-size:3rem;margin-bottom:12px;opacity:.3}
  .empty-state p{font-size:.9rem;max-width:450px;margin:0 auto;line-height:1.7}
  
  /* â”€ missing cards alert â”€ */
  .missing-cards{background:rgba(196,78,58,.1);border:1px solid var(--accent);border-radius:var(--r);padding:14px 18px;margin-bottom:20px;color:var(--accent)}
  .missing-cards strong{display:block;margin-bottom:6px;font-size:.88rem}
  .missing-cards ul{margin-left:20px;font-size:.82rem;line-height:1.6}
  
  /* â”€ cart overlay â”€ */
  .cart-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(4px);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .3s}
  .cart-overlay.open{opacity:1;pointer-events:auto}
  
  .cart-panel{background:var(--bg-card);border:2px solid var(--border);border-radius:var(--r);max-width:700px;width:100%;max-height:85vh;overflow-y:auto;padding:28px;position:relative;transform:translateY(20px);transition:transform .3s;box-shadow:0 12px 50px rgba(0,0,0,.8)}
  .cart-overlay.open .cart-panel{transform:translateY(0)}
  
  .cart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid var(--border)}
  .cart-title{font-family:'Cinzel',serif;font-size:1.4rem;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .cart-close{background:none;border:none;color:var(--txt2);font-size:1.6rem;cursor:pointer;transition:color .15s;line-height:1}
  .cart-close:hover{color:var(--accent)}
  
  .cart-empty{text-align:center;padding:40px 20px;color:var(--txt2)}
  .cart-empty .icon{font-size:2.5rem;margin-bottom:10px;opacity:.3}
  
  .cart-owner-section{margin-bottom:28px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--r);padding:18px;position:relative}
  .cart-owner-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .cart-owner-name{font-weight:700;font-size:1rem;color:var(--gold)}
  .whatsapp-btn{background:#25d366;color:#fff;border:none;border-radius:var(--r-sm);font-family:inherit;font-size:.8rem;font-weight:600;padding:8px 16px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px}
  .whatsapp-btn:hover{background:#20ba56;box-shadow:0 0 12px rgba(37,211,102,.3)}
  
  .cart-item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(58,40,32,.3);font-size:.85rem}
  .cart-item:last-child{border-bottom:none}
  .cart-item-name{color:var(--txt);font-weight:500}
  .cart-item-qty{color:var(--accent);font-weight:600;margin-right:auto;margin-left:10px}
  .cart-item-remove{background:var(--accent);color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:1.1rem;font-weight:700;padding:4px 10px;transition:all .15s;min-width:32px;text-align:center}
  .cart-item-remove:hover{background:#ff4757;transform:scale(1.05)}
  
  .cart-actions{display:flex;gap:10px;margin-top:20px;padding-top:20px;border-top:2px solid var(--border)}
  
  /* â”€ modal (card details) â”€ */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(4px);z-index:400;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .25s}
  .modal-overlay.open{opacity:1;pointer-events:auto}
  .modal{background:var(--bg-card);border:2px solid var(--border);border-radius:var(--r);max-width:650px;width:100%;max-height:85vh;overflow-y:auto;padding:28px;position:relative;transform:translateY(18px);transition:transform .25s;box-shadow:0 12px 50px rgba(0,0,0,.8)}
  .modal-overlay.open .modal{transform:translateY(0)}
  .modal-close{position:absolute;top:14px;right:16px;background:none;border:none;color:var(--txt2);font-size:1.5rem;cursor:pointer;transition:color .15s;line-height:1}
  .modal-close:hover{color:var(--accent)}
  .modal-card-name{font-family:'Cinzel',serif;font-size:1.3rem;font-weight:700;margin-bottom:14px;color:var(--txt)}
  .modal-img-wrap{text-align:center;margin:18px 0}
  .modal-img-wrap img{max-width:100%;max-height:320px;border-radius:6px;box-shadow:0 8px 32px rgba(0,0,0,.6)}
  
  .modal-owners-section{margin-top:20px}
  .modal-section-label{font-size:.75rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--txt2);font-weight:600;margin-bottom:10px}
  .modal-owner-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--r-sm);margin-bottom:8px}
  .modal-owner-row .mor-name{color:var(--gold);font-weight:600;font-size:.88rem}
  .modal-owner-row .mor-qty{color:var(--accent);font-weight:700;font-size:.82rem;margin-left:auto;margin-right:12px}
  .modal-owner-row .mor-phone{color:var(--txt2);font-size:.76rem;margin-right:12px}
  .modal-owner-row .add-btn{background:var(--accent);color:#fff;border:none;border-radius:50%;width:36px;height:36px;font-size:1.3rem;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;padding:0;flex-shrink:0}
  .modal-owner-row .add-btn:hover{background:#ff4757;transform:scale(1.08)}
  
  /* â”€ status bar â”€ */
  .status-bar{font-size:.8rem;color:var(--txt2);min-height:20px;margin-top:12px;display:flex;align-items:center;gap:8px}
  .status-bar .spinner{width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;display:none}
  .status-bar.loading .spinner{display:block}
  .status-bar .err{color:var(--accent)}
  .status-bar .ok{color:var(--green)}
  @keyframes spin{to{transform:rotate(360deg)}}
  
  /* â”€ responsive â”€ */
  @media(max-width:700px){
    header{padding:10px 14px;flex-wrap:wrap}
    .header-actions{width:100%;justify-content:space-between}
    .meta-info{order:3;width:100%;text-align:left;margin-top:8px}
    .container{padding:20px 14px}
    .search-panel{padding:18px}
    .mode-toggle{width:100%}
    .mode-toggle button{flex:1}
    table{font-size:.8rem}
    thead th,tbody td{padding:10px 8px}
    .cart-panel,.modal{padding:20px}
  }
  
  ::-webkit-scrollbar{width:8px;height:8px}
  ::-webkit-scrollbar-track{background:var(--bg-deep)}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
  ::-webkit-scrollbar-thumb:hover{background:var(--accent)}
</style>
</head>
<body>

<header>
  <div>
    <div class="logo">âœ¦ Invi Finder<span class="logo-sub">EncontrÃ¡ quiÃ©n tiene quÃ©</span></div>
  </div>
  <div class="header-actions">
    <div class="meta-info">
      <div id="metaCards"><strong>â€”</strong> cartas</div>
      <div id="metaUpdated">actualizado <strong>â€”</strong></div>
    </div>
    <button class="cart-btn" onclick="openCart()">
      ğŸ›’ Carrito
      <span class="badge" id="cartBadge" style="display:none">0</span>
    </button>
  </div>
</header>

<div class="container">
  
  <!-- MODE TOGGLE -->
  <div class="mode-toggle">
    <button class="active" onclick="setMode('single')">BÃºsqueda Simple</button>
    <button onclick="setMode('bulk')">Importar Lista</button>
  </div>
  
  <!-- SEARCH PANEL -->
  <div class="search-panel">
    <!-- SINGLE SEARCH -->
    <div id="singleSearch" class="single-search">
      <div class="search-wrap">
        <span class="search-icon">ğŸ”</span>
        <input type="text" id="searchInput" placeholder="Buscar carta... (presiona Enter)" oninput="onSearchInput()" autocomplete="off"/>
        <div class="autocomplete" id="autocomplete"></div>
      </div>
      <div class="status-bar" id="statusBar">
        <div class="spinner"></div>
        <span id="statusText"></span>
      </div>
    </div>
    
    <!-- BULK IMPORT -->
    <div id="bulkSearch" class="bulk-area">
      <textarea id="bulkInput" placeholder="Pega tu lista aquÃ­:
1 Aqueous Form (THS) 39 *F*
4 Armored Armadillo (OTJ) 3
2 Brazen Borrower / Petty Theft (ELD) 39
..."></textarea>
      <div class="bulk-actions">
        <button class="btn" onclick="processBulk()">Analizar Lista</button>
        <button class="btn btn-secondary" onclick="clearBulk()">Limpiar</button>
      </div>
      <div class="status-bar" id="bulkStatus">
        <div class="spinner"></div>
        <span id="bulkStatusText"></span>
      </div>
    </div>
  </div>
  
  <!-- MISSING CARDS ALERT (for bulk import) -->
  <div id="missingAlert" style="display:none"></div>
  
  <!-- RESULTS -->
  <div>
    <div class="results-header">
      <span class="results-count" id="resultsCount"></span>
    </div>
    <div id="resultsBody">
      <div class="empty-state">
        <div class="icon">ğŸƒ</div>
        <p>Cargando datos...</p>
      </div>
    </div>
  </div>
  
</div>

<!-- CART OVERLAY -->
<div class="cart-overlay" id="cartOverlay" onclick="closeCartOnOverlay(event)">
  <div class="cart-panel">
    <div class="cart-header">
      <div class="cart-title">Carrito</div>
      <button class="cart-close" onclick="closeCart()">&times;</button>
    </div>
    <div id="cartBody"></div>
    <div class="cart-actions">
      <button class="btn btn-secondary" onclick="clearCart()">Vaciar Carrito</button>
    </div>
  </div>
</div>

<!-- MODAL (card details) -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOnOverlay(event)">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">&times;</button>
    <div class="modal-card-name" id="modalName"></div>
    <div class="modal-img-wrap" id="modalImg"></div>
    <div class="modal-owners-section">
      <div class="modal-section-label">DueÃ±os</div>
      <div id="modalOwners"></div>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// cardDB: Map<lowerName, { name, owners: Map<lowerOwner, {display, qty}>, scryfallData }>
const cardDB  = new Map();

// owners: [ { name, phone, cardCount } ]
let owners = [];

// cart: Map<ownerName, Map<cardName, qty>>
// e.g. { "Fausto": { "Lightning Bolt": 2, "Island": 1 } }
const cart = new Map();

// current mode: 'single' or 'bulk'
let currentMode = 'single';

// bulk results (for filtering)
let bulkResults = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async function boot() {
  setStatus('Cargando datos...', 'loading');

  try {
    const res  = await fetch('./data/cards.json');
    if (!res.ok) throw new Error(`data/cards.json devolviÃ³ HTTP ${res.status}`);
    const data = await res.json();

    owners = data.owners || [];

    for (const [key, card] of Object.entries(data.cards)) {
      const ownerMap = new Map();
      for (const [ownerName, qty] of Object.entries(card.owners)) {
        ownerMap.set(ownerName.toLowerCase(), { display: ownerName, qty });
      }
      cardDB.set(key, { name: card.name, owners: ownerMap, scryfallData: null });
    }

    document.getElementById('metaCards').innerHTML =
      `<strong>${cardDB.size.toLocaleString()}</strong> cartas`;

    if (data.lastUpdated) {
      const d = new Date(data.lastUpdated);
      const rel = relativeTime(d);
      document.getElementById('metaUpdated').innerHTML =
        `actualizado <strong>${rel}</strong>`;
    }

    setStatus(`âœ“ ${cardDB.size.toLocaleString()} cartas Ãºnicas cargadas.`, 'ok');
    
    loadCartFromStorage();
    updateCartBadge();

  } catch (e) {
    setStatus(`Error: ${e.message}`, 'err');
  }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODE TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setMode(mode) {
  currentMode = mode;
  
  document.querySelectorAll('.mode-toggle button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  
  if (mode === 'single') {
    document.getElementById('singleSearch').style.display = 'block';
    document.getElementById('bulkSearch').classList.remove('active');
    document.getElementById('missingAlert').style.display = 'none';
    renderResults();
  } else {
    document.getElementById('singleSearch').style.display = 'none';
    document.getElementById('bulkSearch').classList.add('active');
    document.getElementById('resultsBody').innerHTML =
      `<div class="empty-state"><div class="icon">ğŸ“‹</div>
       <p>Pega tu lista de cartas arriba y haz clic en "Analizar Lista".</p></div>`;
    document.getElementById('filterRow').style.display = 'none';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BULK IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function processBulk() {
  const text = document.getElementById('bulkInput').value.trim();
  if (!text) {
    setBulkStatus('Pega una lista primero.', 'err');
    return;
  }
  
  setBulkStatus('Procesando...', 'loading');
  
  const lines = text.split('\n');
  const parsed = [];
  const missing = [];
  
  for (const line of lines) {
    if (!line.trim()) continue;
    
    // Parse format: "4 Card Name (SET) 123 *F*"
    // We want: qty + name
    // Ignore everything in parentheses and after
    const match = line.match(/^(\d+)\s+(.+?)(?:\s+\(|$)/);
    if (!match) continue;
    
    const qty  = parseInt(match[1], 10);
    let name   = match[2].trim();
    
    // remove any trailing stuff like " / Petty Theft" (double-faced cards)
    // keep only the first part
    if (name.includes(' // ')) name = name.split(' // ')[0].trim();
    if (name.includes(' / '))  name = name.split(' / ')[0].trim();
    
    const key = name.toLowerCase();
    
    if (cardDB.has(key)) {
      parsed.push({ name: cardDB.get(key).name, qty, key });
    } else {
      missing.push(name);
    }
  }
  
  if (!parsed.length && !missing.length) {
    setBulkStatus('No se encontraron cartas vÃ¡lidas en el formato esperado.', 'err');
    return;
  }
  
  bulkResults = parsed;
  
  setBulkStatus(`âœ“ ${parsed.length} cartas encontradas.${missing.length ? ` ${missing.length} no disponibles.` : ''}`, 'ok');
  
  if (missing.length) {
    const html = `<div class="missing-cards">
      <strong>âš  Cartas no disponibles (${missing.length}):</strong>
      <ul>${missing.slice(0, 10).map(n => `<li>${esc(n)}</li>`).join('')}${missing.length > 10 ? `<li><em>...y ${missing.length - 10} mÃ¡s</em></li>` : ''}</ul>
    </div>`;
    document.getElementById('missingAlert').innerHTML = html;
    document.getElementById('missingAlert').style.display = 'block';
  } else {
    document.getElementById('missingAlert').style.display = 'none';
  }
  
  renderBulkResults();
}

function clearBulk() {
  document.getElementById('bulkInput').value = '';
  bulkResults = [];
  document.getElementById('missingAlert').style.display = 'none';
  setBulkStatus('', '');
  document.getElementById('resultsBody').innerHTML =
    `<div class="empty-state"><div class="icon">ğŸ“‹</div>
     <p>Pega tu lista de cartas arriba y haz clic en "Analizar Lista".</p></div>`;
}

function renderBulkResults() {
  let rows = [];
  
  for (const item of bulkResults) {
    const entry = cardDB.get(item.key);
    if (!entry) continue;
    
    rows.push({ ...entry, requestedQty: item.qty });
  }
  
  document.getElementById('resultsCount').textContent = rows.length
    ? `${rows.length} carta${rows.length !== 1 ? 's' : ''} disponibles`
    : '';
  
  if (!rows.length) {
    document.getElementById('resultsBody').innerHTML =
      `<div class="empty-state"><div class="icon">ğŸ”</div>
       <p>Ninguna carta de tu lista estÃ¡ disponible con este filtro.</p></div>`;
    return;
  }
  
  let html = `<div class="table-wrap"><table><thead><tr>
    <th>Carta (solicitadas)</th>
    <th>Disponible en</th>
    <th style="text-align:right;width:100px">Precio estimado</th>
  </tr></thead><tbody>`;
  
  for (const entry of rows) {
    const badges = [...entry.owners.values()].map(v => {
      const ownerLower = v.display.toLowerCase();
      const ownerName = v.display;
      
      // calculate remaining
      const inCart = cart.has(ownerName) ? (cart.get(ownerName).get(entry.name) || 0) : 0;
      const remaining = v.qty - inCart;
      const disabled = remaining <= 0;
      
      return `<div class="owner-badge">
                ${esc(v.display)} <span class="qty">${remaining}Ã—</span>
                <button class="add-btn" 
                  onclick="addToCart('${ownerLower}','${entry.name.replace(/'/g,"\\'")}',1)" 
                  title="AÃ±adir al carrito"
                  ${disabled ? 'disabled style="opacity:0.3;cursor:not-allowed"' : ''}>+</button>
              </div>`;
    }).join('');
    
    html += `<tr onclick="openModal('${entry.name.replace(/'/g, "\\'")}')">
               <td class="card-name-cell">${esc(entry.name)} <span style="color:var(--txt2);font-size:.8rem">(${entry.requestedQty})</span></td>
               <td><div class="owner-badges">${badges}</div></td>
               <td style="text-align:right;color:var(--txt2);font-size:.82rem" id="price-${entry.name.replace(/[^a-z0-9]/gi,'_')}">â€”</td>
             </tr>`;
  }
  
  html += '</tbody></table></div>';
  document.getElementById('resultsBody').innerHTML = html;
  
  // fetch prices
  for (const entry of rows) {
    fetchPrice(entry);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SINGLE SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sortCol = 'name', sortDir = 1;

function renderResults() {
  if (currentMode === 'bulk') return;
  
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  
  // NEVER show all cards - require search query
  if (!q) {
    document.getElementById('resultsCount').textContent = '';
    document.getElementById('resultsBody').innerHTML =
      `<div class="empty-state"><div class="icon">ğŸ”</div>
       <p>Escribe el nombre de una carta para buscar.</p></div>`;
    return;
  }
  
  let rows = [];
  
  for (const [key, entry] of cardDB) {
    if (!key.includes(q)) continue;
    rows.push(entry);
    
    // Limit to 100 results max to avoid performance issues
    if (rows.length >= 100) break;
  }
  
  rows.sort((a, b) => {
    if (sortCol === 'owners') return sortDir * (b.owners.size - a.owners.size);
    return sortDir * a.name.localeCompare(b.name);
  });
  
  document.getElementById('resultsCount').textContent = rows.length
    ? `${rows.length.toLocaleString()} carta${rows.length !== 1 ? 's' : ''}${rows.length >= 100 ? ' (limitado a 100, refina tu bÃºsqueda)' : ''}`
    : '';
  
  if (!rows.length) {
    document.getElementById('resultsBody').innerHTML =
      `<div class="empty-state"><div class="icon">ğŸ”</div>
       <p>No se encontraron cartas con "${esc(q)}".</p></div>`;
    return;
  }
  
  const arrow = col => sortCol === col ? (sortDir === 1 ? 'â–²' : 'â–¼') : '';
  
  let html = `<div class="table-wrap"><table><thead><tr>
    <th data-sort="name" onclick="toggleSort('name')">Carta <span class="sort-arrow">${arrow('name')}</span></th>
    <th data-sort="owners" onclick="toggleSort('owners')">Disponible en <span class="sort-arrow">${arrow('owners')}</span></th>
    <th style="text-align:right;width:100px">Precio estimado</th>
  </tr></thead><tbody>`;
  
  for (const entry of rows) {
    const badges = [...entry.owners.values()].map(v => {
      const ownerLower = v.display.toLowerCase();
      const ownerName = v.display;
      
      // calculate how many are already in cart
      const inCart = cart.has(ownerName) ? (cart.get(ownerName).get(entry.name) || 0) : 0;
      const remaining = v.qty - inCart;
      const disabled = remaining <= 0;
      
      return `<div class="owner-badge">
                ${esc(v.display)} <span class="qty">${remaining}Ã—</span>
                <button class="add-btn" 
                  onclick="addToCart('${ownerLower}','${entry.name.replace(/'/g,"\\'")}',1)" 
                  title="AÃ±adir al carrito"
                  ${disabled ? 'disabled style="opacity:0.3;cursor:not-allowed"' : ''}>+</button>
              </div>`;
    }).join('');
    
    html += `<tr onclick="openModal('${entry.name.replace(/'/g, "\\'")}')">
               <td class="card-name-cell">${esc(entry.name)}</td>
               <td><div class="owner-badges">${badges}</div></td>
               <td style="text-align:right;color:var(--txt2);font-size:.82rem" id="price-${entry.name.replace(/[^a-z0-9]/gi,'_')}">â€”</td>
             </tr>`;
  }
  
  html += '</tbody></table></div>';
  document.getElementById('resultsBody').innerHTML = html;
  
  // fetch prices asynchronously for visible cards (don't block rendering)
  for (const entry of rows) {
    fetchPrice(entry);
  }
}

function toggleSort(col) {
  if (sortCol === col) sortDir *= -1;
  else { sortCol = col; sortDir = 1; }
  renderResults();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRICE FETCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchPrice(entry) {
  const cellId = `price-${entry.name.replace(/[^a-z0-9]/gi,'_')}`;
  const cell = document.getElementById(cellId);
  if (!cell) return;
  
  // if we already have scryfall data with price, use it
  if (entry.scryfallData?.prices?.usd) {
    cell.textContent = `$${entry.scryfallData.prices.usd}`;
    return;
  }
  
  // otherwise fetch it
  try {
    const r = await fetch(`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(entry.name)}`);
    if (!r.ok) {
      cell.textContent = 'â€”';
      return;
    }
    const data = await r.json();
    entry.scryfallData = data; // cache it
    
    const price = data.prices?.usd;
    if (price) {
      cell.textContent = `$${price}`;
    } else {
      cell.textContent = 'â€”';
    }
  } catch {
    cell.textContent = 'â€”';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCRYFALL AUTOCOMPLETE (with Spanish support)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let acTimeout = null;
let lastAcQ   = '';

function onSearchInput() {
  const q = document.getElementById('searchInput').value.trim();
  clearTimeout(acTimeout);
  
  // Close autocomplete if search is empty
  if (q.length === 0) {
    closeAC();
    return;
  }
  
  // Only show autocomplete if 2+ chars
  if (q.length < 2) { closeAC(); return; }
  acTimeout = setTimeout(() => fetchScryfall(q), 350);
}

async function fetchScryfall(q) {
  if (q === lastAcQ) return;
  lastAcQ = q;
  
  try {
    // Use Scryfall's autocomplete endpoint for partial matching
    const r = await fetch(`https://api.scryfall.com/cards/autocomplete?q=${encodeURIComponent(q)}`);
    if (!r.ok) { closeAC(); return; }
    const d = await r.json();
    
    // Autocomplete returns just card names, we need full card data
    // So we take the names and fetch details for the first few
    const names = d.data || [];
    if (!names.length) { closeAC(); return; }
    
    // Fetch full card data for first 8 results (for images and details)
    const cardPromises = names.slice(0, 8).map(name =>
      fetch(`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(name)}`)
        .then(r => r.ok ? r.json() : null)
        .catch(() => null)
    );
    
    const cards = (await Promise.all(cardPromises)).filter(c => c !== null);
    renderAC(cards, q);
  } catch { closeAC(); }
}

function renderAC(cards, query) {
  const el = document.getElementById('autocomplete');
  if (!cards.length) { closeAC(); return; }
  
  // Rank results: exact match or prefix match first
  const qLower = query.toLowerCase();
  cards.sort((a, b) => {
    const aName = a.name.toLowerCase();
    const bName = b.name.toLowerCase();
    const aExact = aName === qLower;
    const bExact = bName === qLower;
    if (aExact && !bExact) return -1;
    if (!aExact && bExact) return 1;
    const aPrefix = aName.startsWith(qLower);
    const bPrefix = bName.startsWith(qLower);
    if (aPrefix && !bPrefix) return -1;
    if (!aPrefix && bPrefix) return 1;
    return 0;
  });
  
  el.innerHTML = cards.slice(0, 10).map(c => {
    const imgSrc = c.image_uris?.small || c.card_faces?.[0]?.image_uris?.small || '';
    return `<div class="autocomplete-item" onclick="selectAC('${c.name.replace(/'/g, "\\'")}')">
       ${imgSrc ? `<img src="${imgSrc}" alt="" loading="lazy"/>` : ''}
       <div class="ac-info">
         <div class="ac-name">${esc(c.name)}</div>
         <div class="ac-type">${esc(c.type_line || '')}</div>
       </div>
     </div>`;
  }).join('');
  el.classList.add('open');
}

function selectAC(name) {
  document.getElementById('searchInput').value = name;
  closeAC();
  renderResults(); // NOW render results when user selects from autocomplete
}

function closeAC() {
  document.getElementById('autocomplete').classList.remove('open');
}

document.addEventListener('mousedown', e => {
  if (!e.target.closest('.search-wrap')) closeAC();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addToCart(ownerLower, cardName, qty = 1) {
  event.stopPropagation(); // prevent modal from opening when clicking + in table
  
  // find the actual owner display name
  const owner = owners.find(o => o.name.toLowerCase() === ownerLower);
  if (!owner) return;
  
  const ownerName = owner.name;
  
  if (!cart.has(ownerName)) cart.set(ownerName, new Map());
  
  const ownerCart = cart.get(ownerName);
  ownerCart.set(cardName, (ownerCart.get(cardName) || 0) + qty);
  
  updateCartBadge();
  saveCartToStorage();
  
  // refresh the current view to update quantities
  if (currentMode === 'bulk' && bulkResults.length) {
    renderBulkResults();
  } else {
    renderResults();
  }
  
  // if modal is open and it's this card, refresh the modal too
  const modalOverlay = document.getElementById('modalOverlay');
  if (modalOverlay.classList.contains('open')) {
    const modalName = document.getElementById('modalName').textContent;
    if (modalName === cardName) {
      // just update the modal owners section without re-fetching image
      const entry = cardDB.get(cardName.toLowerCase());
      if (entry) {
        const ownersHTML = [...entry.owners.values()].map(v => {
          const ownerLower = v.display.toLowerCase();
          const ownerName = v.display;
          
          const inCart = cart.has(ownerName) ? (cart.get(ownerName).get(entry.name) || 0) : 0;
          const remaining = v.qty - inCart;
          const disabled = remaining <= 0;
          
          return `<div class="modal-owner-row">
            <span class="mor-name">${esc(v.display)}</span>
            <span class="mor-qty">${remaining}Ã—</span>
            <button class="add-btn" 
              onclick="addToCart('${ownerLower}','${entry.name.replace(/'/g,"\\'")}',1)" 
              title="AÃ±adir al carrito"
              ${disabled ? 'disabled style="opacity:0.3;cursor:not-allowed"' : ''}>+</button>
          </div>`;
        }).join('');
        
        document.getElementById('modalOwners').innerHTML = ownersHTML;
      }
    }
  }
  
  // brief visual feedback on the button that was clicked
  const btn = event.target;
  const orig = btn.textContent;
  btn.textContent = 'âœ“';
  btn.style.background = 'var(--green)';
  setTimeout(() => {
    btn.textContent = orig;
    btn.style.background = '';
  }, 400);
}

function removeFromCart(ownerName, cardName) {
  if (!cart.has(ownerName)) return;
  
  const ownerCart = cart.get(ownerName);
  const current = ownerCart.get(cardName) || 0;
  
  if (current > 1) {
    ownerCart.set(cardName, current - 1);
  } else {
    ownerCart.delete(cardName);
    if (ownerCart.size === 0) cart.delete(ownerName);
  }
  
  updateCartBadge();
  saveCartToStorage();
  renderCart();
}

function clearCart() {
  if (!confirm('Â¿Vaciar el carrito?')) return;
  cart.clear();
  updateCartBadge();
  saveCartToStorage();
  renderCart();
}

function updateCartBadge() {
  let total = 0;
  for (const ownerCart of cart.values()) {
    for (const qty of ownerCart.values()) total += qty;
  }
  
  const badge = document.getElementById('cartBadge');
  if (total > 0) {
    badge.textContent = total;
    badge.style.display = 'inline-block';
  } else {
    badge.style.display = 'none';
  }
}

function openCart() {
  renderCart();
  document.getElementById('cartOverlay').classList.add('open');
}

function closeCart() {
  document.getElementById('cartOverlay').classList.remove('open');
}

function closeCartOnOverlay(e) {
  if (e.target === document.getElementById('cartOverlay')) closeCart();
}

function renderCart() {
  const body = document.getElementById('cartBody');
  
  if (cart.size === 0) {
    body.innerHTML = `<div class="cart-empty">
      <div class="icon">ğŸ›’</div>
      <p>El carrito estÃ¡ vacÃ­o.</p>
    </div>`;
    return;
  }
  
  let html = '';
  
  for (const [ownerName, ownerCart] of cart) {
    const owner = owners.find(o => o.name === ownerName);
    const phone = owner?.phone || '';
    
    html += `<div class="cart-owner-section">
      <div class="cart-owner-header">
        <div class="cart-owner-name">${esc(ownerName)}</div>
        <button class="whatsapp-btn" onclick="sendWhatsApp('${ownerName.replace(/'/g, "\\'")}')">
          ğŸ“± WhatsApp
        </button>
      </div>`;
    
    for (const [cardName, qty] of ownerCart) {
      html += `<div class="cart-item">
        <span class="cart-item-name">${esc(cardName)}</span>
        <span class="cart-item-qty">${qty}Ã—</span>
        <button class="cart-item-remove" onclick="removeFromCart('${ownerName.replace(/'/g, "\\'")}','${cardName.replace(/'/g, "\\'")}')" title="Quitar una copia">âˆ’</button>
      </div>`;
    }
    
    html += `</div>`;
  }
  
  body.innerHTML = html;
}

function sendWhatsApp(ownerName) {
  const owner = owners.find(o => o.name === ownerName);
  if (!owner || !owner.phone) {
    alert('No hay nÃºmero de telÃ©fono registrado para ' + ownerName);
    return;
  }
  
  const ownerCart = cart.get(ownerName);
  if (!ownerCart || ownerCart.size === 0) return;
  
  // Build message in Spanish
  let msg = `Hola ${ownerName}, me interesan estas cartas:\n`;
  
  for (const [cardName, qty] of ownerCart) {
    msg += `${qty}x ${cardName}\n`;
  }
  
  // WhatsApp URL format: https://wa.me/PHONE?text=MESSAGE
  // Remove any non-digits from phone
  const cleanPhone = owner.phone.replace(/\D/g, '');
  const url = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`;
  
  window.open(url, '_blank');
}

// localStorage persistence
function saveCartToStorage() {
  try {
    const data = {};
    for (const [owner, items] of cart) {
      data[owner] = Object.fromEntries(items);
    }
    localStorage.setItem('invifinder_cart', JSON.stringify(data));
  } catch (e) {
    console.warn('No se pudo guardar el carrito:', e);
  }
}

function loadCartFromStorage() {
  try {
    const stored = localStorage.getItem('invifinder_cart');
    if (!stored) return;
    
    const data = JSON.parse(stored);
    for (const [owner, items] of Object.entries(data)) {
      cart.set(owner, new Map(Object.entries(items)));
    }
  } catch (e) {
    console.warn('No se pudo cargar el carrito:', e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL (card details)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openModal(name) {
  const entry = cardDB.get(name.toLowerCase());
  if (!entry) return;
  
  document.getElementById('modalName').textContent = entry.name;
  
  // build owner rows with + buttons
  const phoneMap = {};
  for (const o of owners) phoneMap[o.name.toLowerCase()] = o.phone || '';
  
  const ownersHTML = [...entry.owners.values()].map(v => {
    const ownerLower = v.display.toLowerCase();
    const ownerName = v.display;
    
    // calculate remaining
    const inCart = cart.has(ownerName) ? (cart.get(ownerName).get(entry.name) || 0) : 0;
    const remaining = v.qty - inCart;
    const disabled = remaining <= 0;
    
    return `<div class="modal-owner-row">
      <span class="mor-name">${esc(v.display)}</span>
      <span class="mor-qty">${remaining}Ã—</span>
      <button class="add-btn" 
        onclick="addToCart('${ownerLower}','${entry.name.replace(/'/g,"\\'")}',1)" 
        title="AÃ±adir al carrito"
        ${disabled ? 'disabled style="opacity:0.3;cursor:not-allowed"' : ''}>+</button>
    </div>`;
  }).join('');
  
  document.getElementById('modalOwners').innerHTML = ownersHTML;
  
  // image
  const imgEl = document.getElementById('modalImg');
  imgEl.innerHTML = '<span style="color:var(--txt2);font-size:.82rem">Cargando imagenâ€¦</span>';
  
  if (!entry.scryfallData) {
    try {
      const r = await fetch(`https://api.scryfall.com/cards/named?exact=${encodeURIComponent(entry.name)}`);
      if (r.ok) entry.scryfallData = await r.json();
    } catch {}
  }
  
  const sf  = entry.scryfallData;
  const src = sf?.image_uris?.normal || sf?.card_faces?.[0]?.image_uris?.normal || '';
  imgEl.innerHTML = src
    ? `<img src="${src}" alt="${esc(entry.name)}" loading="lazy"/>`
    : '<span style="color:var(--txt2)">Sin imagen disponible.</span>';
  
  document.getElementById('modalOverlay').classList.add('open');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
}

function closeModalOnOverlay(e) {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closeModal();
    closeCart();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATUS BARS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(msg, type) {
  const bar  = document.getElementById('statusBar');
  const text = document.getElementById('statusText');
  bar.className = 'status-bar' + (type === 'loading' ? ' loading' : '');
  text.className = type === 'err' ? 'err' : type === 'ok' ? 'ok' : '';
  text.textContent = msg;
}

function setBulkStatus(msg, type) {
  const bar  = document.getElementById('bulkStatus');
  const text = document.getElementById('bulkStatusText');
  bar.className = 'status-bar' + (type === 'loading' ? ' loading' : '');
  text.className = type === 'err' ? 'err' : type === 'ok' ? 'ok' : '';
  text.textContent = msg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function relativeTime(date) {
  const diff = Date.now() - date.getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1)  return 'ahora';
  if (mins < 60) return `hace ${mins}m`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24)  return `hace ${hrs}h`;
  const days = Math.floor(hrs / 24);
  return `hace ${days}d`;
}

document.getElementById('searchInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    const autocomplete = document.getElementById('autocomplete');
    
    // If autocomplete is open, select the first result
    if (autocomplete.classList.contains('open')) {
      const firstItem = autocomplete.querySelector('.autocomplete-item');
      if (firstItem) {
        firstItem.click(); // trigger the onclick handler
        return;
      }
    }
    
    // Otherwise just close autocomplete and trigger search
    closeAC();
    renderResults();
  }
});
</script>
</body>
</html>
